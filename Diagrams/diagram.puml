@startuml

skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam packageStyle rectangle

' --- Core Layer ---
package "Core.ValueObjects" {
    enum StatType {
        Health
        MaxHealth
        Attack
        Armor
        Mana
        Speed
    }

    class CharacterStats {
        - Dictionary<StatType, int> _stats
        + GetStat(type: StatType) : int
        + SetStat(type: StatType, value: int) : void
        + ModifyStat(type: StatType, delta: int) : void
        + ToDictionary() : Dictionary<StatType, int>
    }

    class AttackResult <<record>> {
        + Attacker : string
        + Target : string
        + Damage : int
    }
    
    class AbilityResult <<record>>
    class HealResult <<record>>
}

package "Core.Contracts" {
    interface ICombatEntity {
        + Name : string
        + IsAlive : bool
        + TakeDamage(amount: int) : void
        + Heal(amount: int) : void
        + GetStats() : CharacterStats
        + GetAbilities() : IEnumerable<Ability>
    }

    interface ICombatSystem {
        + Attack(attacker: ICombatEntity, defender: ICombatEntity) : AttackResult
        + UseAbility(user: ICombatEntity, target: ICombatEntity, ability: Ability) : AbilityResult
        + Heal(healer: ICombatEntity, amount: int) : HealResult
    }

    interface ICombatLogger {
        + LogAttack(result: AttackResult) : void
        + LogAbility(result: AbilityResult) : void
        + LogHeal(result: HealResult) : void
        + LogMessage(message: string) : void
    }

    interface ICommand {
        + Keyword : string
        + Description : string
        + Execute(args: string[], options: Dictionary<string, string>) : void
    }

    interface IDisplayer {
        + Write(message: string) : void
        + WriteLine(message: string) : void
        + ReadLine() : string
        + Clear() : void
    }
    
    interface IStatProvider {
        + GetModifiers() : Dictionary<StatType, int>
    }
}

package "Core.Entities" {
    abstract class Character {
        + Name : string
        - CharacterStats _baseStats
        - List<Item> _equipment
        - List<Ability> _abilities
        + IsAlive : bool
        + GetStats() : CharacterStats
        + ToData() : CharacterData
    }

    abstract class Item {
        + Name : string
        + GrantedAbility : Ability?
        + Modifiers : Dictionary<StatType, int>
        # AddModifier(type: StatType, amount: int) : void
    }

    abstract class Ability {
        + Name : string
        + {abstract} CalculateDamage(userStats: CharacterStats, targetStats: CharacterStats) : int
    }
}

package "Core.State" {
    class WorldContext {
        + Characters : List<Character>
        + ItemPool : List<Item>
    }
}

package "Core.Data" {
    class SaveBase {
        + SaveDate : DateTime
        + Characters : List<CharacterData>
    }
    class CharacterData
}

' --- Content Layer ---
package "Content" {
    class Warrior
    class Mage
    class Sword
    class Shield
    class MagicAmulet
    class LightningWand
    class Fireball
    class PowerStrike
    class Lightning
}

' --- Systems Layer ---
package "Systems.Combat" {
    class CombatSystem {
        - ICombatLogger _logger
    }
    
    class BattleManager {
        - ICombatSystem _combatSystem
        - ICombatLogger _logger
        - List<ICombatEntity> _participants
        + StartBattle() : void
    }
}

' --- Text System (Composite Pattern) ---
package "Text" {
    class DocumentContext {
        + Root : Root
        + CurrentContainer : Container
    }
    
    class TextFactory {
        + AddElement(...) : void
    }

    interface IText {
        + Id : Guid
        + Name : string
        + Parent : Container?
        + Render() : string
    }

    abstract class TextBase
    class Container {
        - List<IText> _children
        + AddChild(child: IText) : void
        + RemoveChild(nameOrId: string) : bool
    }
    class Leaf
    class Paragraph
    class Heading
    class Root
}

' --- Infrastructure Layer ---
package "Infrastructure.CLI" {
    class CliEngine {
        - ICliSession _session
        - IDisplayer _displayer
        + Run() : void
    }

    interface ICliSession {
        + ModeName : string
        + ExecuteCommand(...) : void
    }

    class CommandRegistry {
        - Dictionary<string, ICommand> _commands
        + Register(command: ICommand) : void
    }

    class CharacterSession
    class TextSession

    package "Commands" {
        class CreateCommand
        class EquipCommand
        class LsCommand
        class ActCommand
        class HelpCommand
        class AddTextCommand
        class PrintCommand
        class PwdCommand
        class UpCommand
        class RmCommand
        class ChangeDirCommand
        class SaveCommand
        class LoadCommand
    }
}

package "Infrastructure.IO" {
    class ConsoleDisplayer
}

package "Infrastructure.Logging" {
    class ConsoleLogger
    class CompositeLogger
    class CombatFormatter
}

package "Infrastructure.Persistence" {
    class JsonFileRepository {
        + Save(data: SaveBase) : void
        + Load() : SaveBase
    }
}

package "Setup" {
    class GameBuilder {
        + BuildEngine(args: string[]) : CliEngine
    }
}

' --- Relationships ---

' Inheritance
ICombatEntity <|.. Character
Character <|-- Warrior
Character <|-- Mage

Item <|-- Sword
Item <|-- Shield
Item <|-- MagicAmulet
Item <|-- LightningWand

Ability <|-- Fireball
Ability <|-- PowerStrike
Ability <|-- Lightning

ICombatSystem <|.. CombatSystem
ICombatLogger <|.. ConsoleLogger
ICombatLogger <|.. CompositeLogger
IDisplayer <|.. ConsoleDisplayer

IText <|.. TextBase
TextBase <|-- Container
TextBase <|-- Paragraph
Container <|-- Root
Container <|-- Heading

ICliSession <|.. CharacterSession
ICliSession <|.. TextSession

ICommand <|.. ActCommand
ICommand <|.. SaveCommand
ICommand <|.. LoadCommand
ICommand <|.. CreateCommand
ICommand <|.. EquipCommand
ICommand <|.. AddTextCommand

' Association & Composition
Character *-- CharacterStats
Character o-- Item
Character o-- Ability
Item --> Ability : Grants >

CombatSystem --> ICombatLogger
BattleManager --> ICombatSystem
BattleManager --> ICombatLogger

CliEngine --> ICliSession
CliEngine --> IDisplayer
CharacterSession --> CommandRegistry
TextSession --> CommandRegistry
CommandRegistry o-- ICommand

ConsoleLogger --> IDisplayer
ConsoleLogger ..> CombatFormatter

ActCommand --> ICombatSystem
ActCommand --> WorldContext
SaveCommand --> JsonFileRepository
SaveCommand --> WorldContext
LoadCommand --> JsonFileRepository

DocumentContext --> Root
Container o-- IText

JsonFileRepository ..> SaveBase
SaveBase *-- CharacterData
Character ..> CharacterData : Creates >

GameBuilder ..> CliEngine : Creates >
GameBuilder ..> WorldContext : Seeds >
GameBuilder ..> CommandRegistry : Configures >

@enduml